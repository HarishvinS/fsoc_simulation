{% extends "base.html" %}

{% block title %}FSOC Link Optimization - Optimization Results{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3>
                    <i class="bi bi-robot"></i>
                    AI Optimization Results
                </h3>
                <div>
                    <a href="/optimize" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left"></i>
                        New Optimization
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if result.success %}
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle-fill"></i>
                        <strong>Optimization Completed!</strong> 
                        AI analysis complete with {{ "%.0f"|format(result.confidence_score * 100) }}% confidence.
                    </div>
                    
                    <!-- Confidence Score -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-graph-up"></i>
                                        Optimization Confidence
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="progress mb-3" style="height: 30px;">
                                        <div class="progress-bar 
                                            {% if result.confidence_score < 0.5 %}
                                                bg-danger
                                            {% elif result.confidence_score < 0.8 %}
                                                bg-warning
                                            {% else %}
                                                bg-success
                                            {% endif %}" 
                                            role="progressbar" 
                                            style="width: {{ result.confidence_score * 100 }}%;" 
                                            aria-valuenow="{{ result.confidence_score * 100 }}" 
                                            aria-valuemin="0" 
                                            aria-valuemax="100">
                                            {{ "%.0f"|format(result.confidence_score * 100) }}%
                                        </div>
                                    </div>
                                    <p class="mb-0 text-muted">
                                        {% if result.confidence_score >= 0.8 %}
                                            <i class="bi bi-check-circle text-success"></i>
                                            High confidence - Recommended configuration should perform well
                                        {% elif result.confidence_score >= 0.5 %}
                                            <i class="bi bi-exclamation-triangle text-warning"></i>
                                            Moderate confidence - Consider additional analysis
                                        {% else %}
                                            <i class="bi bi-x-circle text-danger"></i>
                                            Low confidence - Challenging conditions detected
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recommended Configuration -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="card h-100 border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-gear-fill"></i>
                                        Recommended Configuration
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-6">
                                            <div class="text-center p-3 bg-light rounded">
                                                <i class="bi bi-broadcast text-primary mb-2" style="font-size: 1.5rem;"></i>
                                                <h6>{{ "%.1f"|format(result.recommendations.tx_height_m) }} m</h6>
                                                <small class="text-muted">Tx Height</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-3 bg-light rounded">
                                                <i class="bi bi-reception-4 text-success mb-2" style="font-size: 1.5rem;"></i>
                                                <h6>{{ "%.1f"|format(result.recommendations.rx_height_m) }} m</h6>
                                                <small class="text-muted">Rx Height</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-3 bg-light rounded">
                                                <i class="bi bi-tools text-warning mb-2" style="font-size: 1.5rem;"></i>
                                                <h6>{{ result.recommendations.tx_material|title|replace('_', ' ') }}</h6>
                                                <small class="text-muted">Tx Material</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-3 bg-light rounded">
                                                <i class="bi bi-tools text-info mb-2" style="font-size: 1.5rem;"></i>
                                                <h6>{{ result.recommendations.rx_material|title|replace('_', ' ') }}</h6>
                                                <small class="text-muted">Rx Material</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100 border-info">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-graph-up"></i>
                                        Expected Performance
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-6">
                                            <div class="text-center p-3 bg-light rounded">
                                                <i class="bi bi-reception-4 text-primary mb-2" style="font-size: 1.5rem;"></i>
                                                <h6>{{ "%.1f"|format(result.recommendations.expected_rx_power_dbm) }} dBm</h6>
                                                <small class="text-muted">Rx Power</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-3 bg-light rounded">
                                                <i class="bi bi-shield-check text-success mb-2" style="font-size: 1.5rem;"></i>
                                                <h6>{{ "%.1f"|format(result.recommendations.link_margin_db) }} dB</h6>
                                                <small class="text-muted">Link Margin</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-3 bg-light rounded">
                                                <i class="bi bi-percent text-warning mb-2" style="font-size: 1.5rem;"></i>
                                                <h6>{{ "%.1f"|format(result.recommendations.expected_reliability * 100) }}%</h6>
                                                <small class="text-muted">Reliability</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-3 bg-light rounded">
                                                <i class="bi bi-star text-info mb-2" style="font-size: 1.5rem;"></i>
                                                <h6>{{ "%.0f"|format(result.recommendations.optimization_score) }}</h6>
                                                <small class="text-muted">Score</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Parameters -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>
                                        <i class="bi bi-sliders"></i>
                                        Complete System Specification
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <table class="table table-striped">
                                                <tbody>
                                                    <tr>
                                                        <th><i class="bi bi-lightning"></i> Tx Power</th>
                                                        <td>{{ "%.1f"|format(result.recommendations.tx_power_dbm) }} dBm</td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="bi bi-lightbulb"></i> Wavelength</th>
                                                        <td>{{ result.recommendations.wavelength_nm }} nm</td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="bi bi-rulers"></i> Link Distance</th>
                                                        <td>{{ "%.2f"|format(((result.recommendations.lat_tx - result.recommendations.lat_rx)**2 + (result.recommendations.lon_tx - result.recommendations.lon_rx)**2)**0.5 * 111) }} km</td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="bi bi-cloud-fog"></i> Avg. Fog</th>
                                                        <td>{{ result.recommendations.avg_fog_density }} g/m³</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <table class="table table-striped">
                                                <tbody>
                                                    <tr>
                                                        <th><i class="bi bi-cloud-rain"></i> Avg. Rain</th>
                                                        <td>{{ result.recommendations.avg_rain_rate }} mm/hr</td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="bi bi-thermometer-sun"></i> Surface Temp</th>
                                                        <td>{{ result.recommendations.avg_surface_temp }}°C</td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="bi bi-thermometer"></i> Ambient Temp</th>
                                                        <td>{{ result.recommendations.avg_ambient_temp }}°C</td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="bi bi-calendar-check"></i> Timestamp</th>
                                                        <td>{{ result.timestamp }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="mb-3">
                                        <i class="bi bi-play-circle"></i>
                                        Next Steps
                                    </h5>
                                    <p class="text-muted mb-3">
                                        Validate these recommendations by running a detailed simulation with the optimized parameters.
                                    </p>
                                    
                                    <form method="POST" action="/simulate" class="d-inline">
                                        <input type="hidden" name="lat_tx" value="{{ result.recommendations.lat_tx }}">
                                        <input type="hidden" name="lon_tx" value="{{ result.recommendations.lon_tx }}">
                                        <input type="hidden" name="height_tx" value="{{ result.recommendations.tx_height_m }}">
                                        <input type="hidden" name="material_tx" value="{{ result.recommendations.tx_material }}">
                                        
                                        <input type="hidden" name="lat_rx" value="{{ result.recommendations.lat_rx }}">
                                        <input type="hidden" name="lon_rx" value="{{ result.recommendations.lon_rx }}">
                                        <input type="hidden" name="height_rx" value="{{ result.recommendations.rx_height_m }}">
                                        <input type="hidden" name="material_rx" value="{{ result.recommendations.rx_material }}">
                                        
                                        <input type="hidden" name="fog_density" value="{{ result.recommendations.avg_fog_density }}">
                                        <input type="hidden" name="rain_rate" value="{{ result.recommendations.avg_rain_rate }}">
                                        <input type="hidden" name="surface_temp" value="{{ result.recommendations.avg_surface_temp }}">
                                        <input type="hidden" name="ambient_temp" value="{{ result.recommendations.avg_ambient_temp }}">
                                        
                                        <input type="hidden" name="wavelength_nm" value="{{ result.recommendations.wavelength_nm }}">
                                        <input type="hidden" name="tx_power_dbm" value="{{ result.recommendations.tx_power_dbm }}">
                                        
                                        <input type="hidden" name="detailed_output" value="true">
                                        
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="bi bi-calculator"></i>
                                            Run Detailed Simulation
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Optimization Failed:</strong> {{ result.error_message }}
                    </div>
                    
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="bi bi-robot" style="font-size: 3rem; color: #dc2626;"></i>
                            <h5 class="mt-3">AI Optimization Unavailable</h5>
                            <p class="text-muted">The optimization service may not be ready. Please ensure the ML models are trained and loaded.</p>
                            <a href="/health" class="btn btn-outline-primary">
                                <i class="bi bi-heart-pulse"></i>
                                Check System Health
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}